-- TSB Metal Bat Predictor (FULL FIXED VERSION WITH TELEPORT UI)

-- ================= SERVICES =================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera

-- ================= CONFIG =================
local lineEnabled = false
local cameraEnabled = false

local previewFolder = Instance.new("Folder")
previewFolder.Name = "TSBPreviewParts"
previewFolder.Parent = Workspace

local GRAVITY = Workspace.Gravity * 0.1
local POWER = 120
local STEPS = 70
local STEP_TIME = 0.08
local STRAIGHT_DISTANCE = 60
local START_BACK_OFFSET = -15
local CAMERA_HEIGHT = 30

-- ================= TELEPORT POINTS =================
local teleportPoints = {
    {"Mountain 1", Vector3.new(0, 653, -363)},
    {"Mountain 2", Vector3.new(615, 641, -175)},
    {"Mountain 3", Vector3.new(320, 671, 442)},
    {"Mountain 4", Vector3.new(-323, 642, 184)}
}

-- ================= CLEAN THROWN =================
local function clearThrown()
    local thrown = Workspace:FindFirstChild("Thrown")
    if thrown then
        pcall(function()
            thrown:Destroy()
        end)
    end
end

-- ================= PREVIEW =================
local function clearPreview()
    for _, p in ipairs(previewFolder:GetChildren()) do
        p:Destroy()
    end
end

local function makePoint(pos)
    local p = Instance.new("Part")
    p.Size = Vector3.new(0.45, 0.45, 0.45)
    p.Shape = Enum.PartType.Ball
    p.Material = Enum.Material.Neon
    p.Color = Color3.fromRGB(255, 255, 0)
    p.Transparency = 0.15
    p.Anchored = true
    p.CanCollide = false
    p.Position = pos
    p.Parent = previewFolder
end

local function simulate(origin, direction)
    clearPreview()

    local pos = origin
    local vel = direction.Unit * POWER
    local traveled = 0

    local rayParams = RaycastParams.new()
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist
    rayParams.FilterDescendantsInstances = {player.Character}

    for i = 1, STEPS do
        if traveled >= STRAIGHT_DISTANCE then
            vel += Vector3.new(0, -GRAVITY * STEP_TIME, 0)
        end

        local nextPos = pos + vel * STEP_TIME
        traveled += (nextPos - pos).Magnitude

        local ray = Workspace:Raycast(pos, nextPos - pos, rayParams)
        if ray then
            makePoint(ray.Position)
            return ray.Position
        end

        makePoint(nextPos)
        pos = nextPos
    end

    return pos
end

-- ================= ESP =================
local function createESP(char)
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp or hrp:FindFirstChild("TSB_ESP") then return end

    local gui = Instance.new("BillboardGui")
    gui.Name = "TSB_ESP"
    gui.Size = UDim2.new(0,120,0,45)
    gui.StudsOffset = Vector3.new(0,3,0)
    gui.AlwaysOnTop = true
    gui.Adornee = hrp
    gui.Parent = hrp

    local dist = Instance.new("TextLabel")
    dist.Name = "Dist"
    dist.Size = UDim2.new(1,0,0.5,0)
    dist.BackgroundTransparency = 1
    dist.TextColor3 = Color3.fromRGB(255,255,0)
    dist.Font = Enum.Font.SourceSansBold
    dist.TextScaled = true
    dist.Parent = gui

    local vel = Instance.new("TextLabel")
    vel.Name = "Vel"
    vel.Size = UDim2.new(1,0,0.5,0)
    vel.Position = UDim2.new(0,0,0.5,0)
    vel.BackgroundTransparency = 1
    vel.TextColor3 = Color3.fromRGB(255,255,0)
    vel.Font = Enum.Font.SourceSansBold
    vel.TextScaled = true
    vel.Parent = gui
end

local function updateESP(landingPos)
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character then
            createESP(plr.Character)
            local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
            if hrp and hrp:FindFirstChild("TSB_ESP") then
                hrp.TSB_ESP.Dist.Text =
                    "Dist: "..math.floor((hrp.Position - landingPos).Magnitude)
                hrp.TSB_ESP.Vel.Text =
                    "Vel: "..math.floor(hrp.Velocity.Magnitude)
            end
        end
    end
end

-- ================= UPDATE =================
local function update()
    if not lineEnabled then return end
    clearThrown()

    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local startPos =
        hrp.Position +
        hrp.CFrame.LookVector * START_BACK_OFFSET +
        Vector3.new(0,2,0)

    local landingPos = simulate(startPos, hrp.CFrame.LookVector)
    updateESP(landingPos)

    if cameraEnabled then
        camera.CameraType = Enum.CameraType.Scriptable
        camera.CFrame =
            CFrame.new(landingPos + Vector3.new(0, CAMERA_HEIGHT, 0), landingPos)
    else
        camera.CameraType = Enum.CameraType.Custom
    end
end

-- ================= TELEPORT GUI =================
local function createTeleportGUI()
    local pg = player:WaitForChild("PlayerGui")

    local old = pg:FindFirstChild("TeleportGUI")
    if old then old:Destroy() end

    local gui = Instance.new("ScreenGui")
    gui.Name = "TeleportGUI"
    gui.ResetOnSpawn = false
    gui.Parent = pg

    for i, info in ipairs(teleportPoints) do
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0,150,0,40)
        btn.Position = UDim2.new(1,-170,0,100+(i-1)*50)
        btn.Text = info[1]
        btn.BackgroundColor3 = Color3.fromRGB(0,0,0)
        btn.BorderColor3 = Color3.fromRGB(128,0,255)
        btn.BorderSizePixel = 2
        btn.TextColor3 = Color3.fromRGB(255,255,0)
        btn.BackgroundTransparency = 0.25
        btn.Font = Enum.Font.SourceSansBold
        btn.TextScaled = true
        btn.Parent = gui

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0,10)
        corner.Parent = btn

        btn.MouseButton1Click:Connect(function()
            local char = player.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                char.HumanoidRootPart.CFrame =
                    CFrame.new(info[2] + Vector3.new(0,5,0))
            end
        end)
    end
end

createTeleportGUI()
player.CharacterAdded:Connect(function()
    task.wait(0.5)
    createTeleportGUI()
end)

-- ================= INPUT =================
UserInputService.InputBegan:Connect(function(input,gp)
    if gp then return end

    if input.KeyCode == Enum.KeyCode.L then
        lineEnabled = not lineEnabled
        if lineEnabled then
            RunService:BindToRenderStep(
                "TSB_UPDATE",
                Enum.RenderPriority.Camera.Value,
                update
            )
        else
            RunService:UnbindFromRenderStep("TSB_UPDATE")
            clearPreview()
            clearThrown()
            camera.CameraType = Enum.CameraType.Custom
        end
    elseif input.KeyCode == Enum.KeyCode.M then
        if UserInputService.MouseBehavior == Enum.MouseBehavior.LockCenter then
            return
        end
        cameraEnabled = true
    end
end)

UserInputService.InputEnded:Connect(function(input,gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.M then
        cameraEnabled = false
        camera.CameraType = Enum.CameraType.Custom
    end
end)
