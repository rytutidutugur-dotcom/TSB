-- TSB Metal Bat Predictor (Optimized for Performance)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera

-- ================= CONFIG =================
local lineEnabled = false
local cameraEnabled = false
local previewPartsFolder = Instance.new("Folder")
previewPartsFolder.Name = "TSBPreviewParts"
previewPartsFolder.Parent = Workspace

local playerESP = {} -- store ESP per player

local GRAVITY = Workspace.Gravity * 0.1
local POWER = 120
local STEPS = 60
local STEP_TIME = 0.08
local STRAIGHT_DISTANCE = 60
local START_BACK_OFFSET = -15
local CAMERA_HEIGHT = 30

local teleportPoints = {
    {"Mountain 1", Vector3.new(0, 653, -363)},
    {"Mountain 2", Vector3.new(615, 641, -175)},
    {"Mountain 3", Vector3.new(320, 671, 442)},
    {"Mountain 4", Vector3.new(-323, 642, 184)}
}

-- ================= FUNCTIONS =================
local function clearPreview()
    for _, p in ipairs(previewPartsFolder:GetChildren()) do
        p:Destroy()
    end
end

local function makePoint(pos)
    local p = Instance.new("Part")
    p.Size = Vector3.new(0.35, 0.35, 0.35)
    p.Shape = Enum.PartType.Ball
    p.Material = Enum.Material.Neon
    p.Color = Color3.fromRGB(255, 255, 255)
    p.Transparency = 0.4
    p.Anchored = true
    p.CanCollide = false
    p.Position = pos
    p.Parent = previewPartsFolder
end

local function simulate(origin, direction)
    clearPreview()
    local pos = origin
    local vel = direction.Unit * POWER
    local traveled = 0

    for i = 1, STEPS do
        if traveled >= STRAIGHT_DISTANCE then
            vel = vel + Vector3.new(0, -GRAVITY * STEP_TIME, 0)
        end

        local nextPos = pos + vel * STEP_TIME
        traveled = traveled + (nextPos - pos).Magnitude

        local rayParams = RaycastParams.new()
        rayParams.FilterDescendantsInstances = {player.Character}
        rayParams.FilterType = Enum.RaycastFilterType.Blacklist

        local ray = Workspace:Raycast(pos, nextPos - pos, rayParams)
        if ray then
            makePoint(ray.Position)
            return ray.Position
        end

        makePoint(nextPos)
        pos = nextPos
    end

    return pos
end

-- ================= ESP =================
local function createESPForPlayer(plr)
    if playerESP[plr] then return end
    if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = plr.Character.HumanoidRootPart

    local gui = Instance.new("BillboardGui")
    gui.Size = UDim2.new(0, 120, 0, 50)
    gui.AlwaysOnTop = true
    gui.StudsOffset = Vector3.new(0, 3, 0)
    gui.Parent = hrp

    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Size = UDim2.new(1, 0, 0.5, 0)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
    distanceLabel.Font = Enum.Font.SourceSansBold
    distanceLabel.TextScaled = true
    distanceLabel.Text = "Dist: 0"
    distanceLabel.Parent = gui

    local velocityLabel = Instance.new("TextLabel")
    velocityLabel.Size = UDim2.new(1, 0, 0.5, 0)
    velocityLabel.Position = UDim2.new(0, 0, 0.5, 0)
    velocityLabel.BackgroundTransparency = 1
    velocityLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
    velocityLabel.Font = Enum.Font.SourceSansBold
    velocityLabel.TextScaled = true
    velocityLabel.Text = "Vel: 0"
    velocityLabel.Parent = gui

    -- ESP box
    local box = Instance.new("Frame")
    box.Size = UDim2.new(1, 0, 1, 0)
    box.Position = UDim2.new(0, 0, 0, 0)
    box.BackgroundTransparency = 0.7
    box.BorderColor3 = Color3.fromRGB(128, 0, 255)
    box.BorderSizePixel = 2
    box.Parent = gui

    playerESP[plr] = {gui=gui, dist=distanceLabel, vel=velocityLabel}
end

local function updateESP(landingPos)
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            createESPForPlayer(plr)
            local hrp = plr.Character.HumanoidRootPart
            local distance = math.ceil((hrp.Position - landingPos).Magnitude)
            local velocity = math.ceil(hrp.Velocity.Magnitude)
            local esp = playerESP[plr]
            esp.dist.Text = "Dist: "..distance
            esp.vel.Text = "Vel: "..velocity
        end
    end
end

-- ================= UPDATE FUNCTION =================
local function update()
    if not lineEnabled then return end
    local char = player.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end

    local startPos = root.Position + root.CFrame.LookVector * START_BACK_OFFSET + Vector3.new(0,2,0)
    local landingPos = simulate(startPos, root.CFrame.LookVector)

    updateESP(landingPos)

    if cameraEnabled then
        camera.CameraType = Enum.CameraType.Scriptable
        local safeY = math.max(landingPos.Y + CAMERA_HEIGHT, landingPos.Y + 5)
        camera.CFrame = CFrame.new(Vector3.new(landingPos.X, safeY, landingPos.Z), landingPos)
    else
        camera.CameraType = Enum.CameraType.Custom
    end
end

-- ================= TELEPORTS =================
local function createTeleportGUI()
    local gui = player:FindFirstChild("PlayerGui"):FindFirstChild("TeleportGUI")
    if gui then gui:Destroy() end

    gui = Instance.new("ScreenGui")
    gui.Name = "TeleportGUI"
    gui.Parent = player:WaitForChild("PlayerGui")

    for i, info in ipairs(teleportPoints) do
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, 150, 0, 40)
        btn.Position = UDim2.new(1, -160, 0, 80 + (i - 1) * 50)
        btn.AnchorPoint = Vector2.new(0, 0)
        btn.Text = info[1]
        btn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        btn.BorderColor3 = Color3.fromRGB(128, 0, 255)
        btn.BorderSizePixel = 2
        btn.TextColor3 = Color3.fromRGB(255, 255, 0)
        btn.BackgroundTransparency = 0.3
        btn.Font = Enum.Font.SourceSansBold
        btn.TextScaled = true
        btn.Parent = gui

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 10)
        corner.Parent = btn

        btn.MouseEnter:Connect(function()
            btn.BackgroundTransparency = 0
        end)
        btn.MouseLeave:Connect(function()
            btn.BackgroundTransparency = 0.3
        end)

        btn.MouseButton1Click:Connect(function()
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.CFrame = CFrame.new(info[2] + Vector3.new(0, 5, 0))
            end
        end)
    end
end

createTeleportGUI()
player.CharacterAdded:Connect(createTeleportGUI)

-- ================= SHIFT LOCK WARNING =================
local warningGui
local function showWarning(text)
    if not warningGui then
        warningGui = Instance.new("ScreenGui")
        warningGui.Name = "ShiftLockWarning"
        warningGui.Parent = player:WaitForChild("PlayerGui")

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 0, 50)
        label.Position = UDim2.new(0, 0, 0, 0)
        label.BackgroundTransparency = 0.5
        label.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        label.TextColor3 = Color3.fromRGB(255, 255, 0)
        label.TextScaled = true
        label.Font = Enum.Font.SourceSansBold
        label.Text = text
        label.Parent = warningGui
    else
        warningGui.Label.Text = text
        warningGui.Enabled = true
    end
end

local function hideWarning()
    if warningGui then warningGui.Enabled = false end
end

-- ================= INPUT HANDLING =================
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.L then
        lineEnabled = not lineEnabled
        if lineEnabled then
            RunService:BindToRenderStep("TSBUpdate", Enum.RenderPriority.Camera.Value, update)
        else
            RunService:UnbindFromRenderStep("TSBUpdate")
            clearPreview()
            camera.CameraType = Enum.CameraType.Custom
        end
    elseif input.KeyCode == Enum.KeyCode.M then
        if UserInputService.MouseBehavior == Enum.MouseBehavior.LockCenter then
            showWarning("Disable shift lock to use camera")
            return
        end
        cameraEnabled = true
    end
end)

UserInputService.InputEnded:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.M then
        cameraEnabled = false
        hideWarning()
        clearPreview()
        camera.CameraType = Enum.CameraType.Custom
    end
end)
