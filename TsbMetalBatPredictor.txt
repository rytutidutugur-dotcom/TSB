-- TSB Metal Bat Predictor (STABLE FIX)

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- ================= CONFIG =================
local LINE_KEY = Enum.KeyCode.L
local CAMERA_KEY = Enum.KeyCode.M

local lineEnabled = false
local cameraEnabled = false

local previewDots = {}
local espMap = {}

local POWER = 120
local STEPS = 65
local STEP_TIME = 0.07
local GRAVITY = Workspace.Gravity * 0.12
local START_OFFSET = -14
local CAMERA_HEIGHT = 32

-- ================= UTILS =================
local function clearThrown()
	local folder = Workspace:FindFirstChild("Thrown")
	if folder then
		for _, obj in ipairs(folder:GetChildren()) do
			obj:Destroy()
		end
	end
end

-- ================= LINE =================
local function clearLine()
	for _, dot in ipairs(previewDots) do
		if dot then dot:Destroy() end
	end
	table.clear(previewDots)
end

local function makeDot(pos, isLanding)
	local p = Instance.new("Part")
	p.Anchored = true
	p.CanCollide = false
	p.Shape = Enum.PartType.Ball
	p.Material = Enum.Material.Neon
	p.Size = isLanding and Vector3.new(1.2,1.2,1.2) or Vector3.new(0.45,0.45,0.45)
	p.Color = isLanding and Color3.fromRGB(255, 80, 80) or Color3.fromRGB(255,255,255)
	p.Transparency = 0.1
	p.Position = pos
	p.Parent = Workspace
	table.insert(previewDots, p)
end

local function simulate(origin, direction)
	clearLine()

	local pos = origin
	local vel = direction.Unit * POWER
	local traveled = 0

	local rayParams = RaycastParams.new()
	rayParams.FilterType = Enum.RaycastFilterType.Blacklist
	rayParams.FilterDescendantsInstances = {LocalPlayer.Character}

	for i = 1, STEPS do
		if traveled > 60 then
			vel += Vector3.new(0, -GRAVITY * STEP_TIME, 0)
		end

		local nextPos = pos + vel * STEP_TIME
		traveled += (nextPos - pos).Magnitude

		local ray = Workspace:Raycast(pos, nextPos - pos, rayParams)
		if ray then
			makeDot(ray.Position, true)
			return ray.Position
		end

		makeDot(nextPos, false)
		pos = nextPos
	end

	makeDot(pos, true)
	return pos
end

-- ================= ESP =================
local function removeESP(plr)
	if espMap[plr] then
		espMap[plr]:Destroy()
		espMap[plr] = nil
	end
end

local function createESP(plr)
	if plr == LocalPlayer then return end

	removeESP(plr)

	local gui = Instance.new("BillboardGui")
	gui.Size = UDim2.new(0,140,0,60)
	gui.StudsOffset = Vector3.new(0,3,0)
	gui.AlwaysOnTop = true

	local frame = Instance.new("Frame")
	frame.Size = UDim2.new(1,0,1,0)
	frame.BackgroundTransparency = 1
	frame.BorderSizePixel = 2
	frame.BorderColor3 = Color3.fromRGB(255,255,255)
	frame.Parent = gui

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1,0,1,0)
	label.BackgroundTransparency = 1
	label.TextColor3 = Color3.new(1,1,1)
	label.TextStrokeTransparency = 0
	label.TextScaled = true
	label.Font = Enum.Font.GothamBold
	label.Parent = frame

	local function attach(char)
		local hrp = char:WaitForChild("HumanoidRootPart", 5)
		if not hrp then return end
		gui.Adornee = hrp
		gui.Parent = Workspace
	end

	if plr.Character then
		attach(plr.Character)
	end

	plr.CharacterAdded:Connect(attach)

	RunService.RenderStepped:Connect(function()
		if not gui.Parent then return end
		local myChar = LocalPlayer.Character
		local char = plr.Character
		if not myChar or not char then return end

		local myHRP = myChar:FindFirstChild("HumanoidRootPart")
		local hrp = char:FindFirstChild("HumanoidRootPart")
		if not myHRP or not hrp then return end

		local dist = (hrp.Position - myHRP.Position).Magnitude
		local vel = hrp.AssemblyLinearVelocity.Magnitude

		label.Text = math.floor(dist) .. " studs\n" .. math.floor(vel) .. " vel"
	end)

	espMap[plr] = gui
end

-- Init ESP
for _, plr in ipairs(Players:GetPlayers()) do
	createESP(plr)
end
Players.PlayerAdded:Connect(createESP)
Players.PlayerRemoving:Connect(removeESP)

-- ================= MAIN LOOP =================
RunService.RenderStepped:Connect(function()
	if not lineEnabled then return end

	clearThrown()

	local char = LocalPlayer.Character
	if not char then return end
	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	local startPos =
		hrp.Position
		+ hrp.CFrame.LookVector * START_OFFSET
		+ Vector3.new(0, 2, 0)

	local landing = simulate(startPos, hrp.CFrame.LookVector)

	if cameraEnabled then
		Camera.CameraType = Enum.CameraType.Scriptable
		Camera.CFrame = CFrame.new(landing + Vector3.new(0, CAMERA_HEIGHT, 0), landing)
	else
		Camera.CameraType = Enum.CameraType.Custom
	end
end)

-- ================= INPUT =================
UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end

	if input.KeyCode == LINE_KEY then
		lineEnabled = not lineEnabled
		if not lineEnabled then
			clearLine()
			Camera.CameraType = Enum.CameraType.Custom
		end

	elseif input.KeyCode == CAMERA_KEY then
		if UserInputService.MouseBehavior ~= Enum.MouseBehavior.LockCenter then
			cameraEnabled = true
		end
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.KeyCode == CAMERA_KEY then
		cameraEnabled = false
		Camera.CameraType = Enum.CameraType.Custom
	end
end)

LocalPlayer.CharacterAdded:Connect(function()
	clearLine()
	Camera.CameraType = Enum.CameraType.Custom
end)
