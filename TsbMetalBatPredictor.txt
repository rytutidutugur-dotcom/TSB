-- TSB Metal Bat Predictor Optimized (FIXED, STABLE)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera

-- ================= CONFIG =================
local lineEnabled = false
local cameraEnabled = false

local previewPartsFolder = Instance.new("Folder")
previewPartsFolder.Name = "TSBPreviewParts"
previewPartsFolder.Parent = Workspace

local GRAVITY = Workspace.Gravity * 0.1
local POWER = 120
local STEPS = 60
local STEP_TIME = 0.08
local STRAIGHT_DISTANCE = 60
local START_BACK_OFFSET = -15
local CAMERA_HEIGHT = 30

local teleportPoints = {
	{"Mountain 1", Vector3.new(0, 653, -363)},
	{"Mountain 2", Vector3.new(615, 641, -175)},
	{"Mountain 3", Vector3.new(320, 671, 442)},
	{"Mountain 4", Vector3.new(-323, 642, 184)}
}

-- ================= CLEAN THROWN =================
local function clearThrown()
	local thrownFolder = Workspace:FindFirstChild("Thrown")
	if thrownFolder then
		for _, v in ipairs(thrownFolder:GetChildren()) do
			v:Destroy()
		end
	end
end

clearThrown()

-- ================= PREVIEW =================
local function clearPreview()
	for _, p in ipairs(previewPartsFolder:GetChildren()) do
		p:Destroy()
	end
end

local function makePoint(pos)
	local p = Instance.new("Part")
	p.Size = Vector3.new(0.45,0.45,0.45)
	p.Shape = Enum.PartType.Ball
	p.Material = Enum.Material.Neon
	p.Color = Color3.fromRGB(255,255,255)
	p.Transparency = 0.25
	p.Anchored = true
	p.CanCollide = false
	p.Position = pos
	p.Parent = previewPartsFolder
end

-- ================= SIMULATION =================
local function simulate(origin, direction)
	clearPreview()

	local pos = origin
	local vel = direction.Unit * POWER
	local traveled = 0

	-- FIX: blacklist ALL characters including local player
	local blacklist = {}
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr.Character then
			table.insert(blacklist, plr.Character)
		end
	end

	local rayParams = RaycastParams.new()
	rayParams.FilterType = Enum.RaycastFilterType.Blacklist
	rayParams.FilterDescendantsInstances = blacklist

	for i = 1, STEPS do
		if traveled >= STRAIGHT_DISTANCE then
			vel += Vector3.new(0, -GRAVITY * STEP_TIME, 0)
		end

		local nextPos = pos + vel * STEP_TIME
		traveled += (nextPos - pos).Magnitude

		local ray = Workspace:Raycast(pos, nextPos - pos, rayParams)
		if ray then
			makePoint(ray.Position)
			return ray.Position
		end

		makePoint(nextPos)
		pos = nextPos
	end

	return pos
end

-- ================= ESP =================
local function createESPForCharacter(char)
	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	if hrp:FindFirstChild("TSB_ESP") then return end

	local gui = Instance.new("BillboardGui")
	gui.Name = "TSB_ESP"
	gui.Size = UDim2.new(0,130,0,55)
	gui.StudsOffset = Vector3.new(0,3,0)
	gui.AlwaysOnTop = true
	gui.Adornee = hrp
	gui.Parent = hrp

	local distLabel = Instance.new("TextLabel")
	distLabel.Name = "Dist"
	distLabel.Size = UDim2.new(1,0,0.5,0)
	distLabel.BackgroundTransparency = 1
	distLabel.TextColor3 = Color3.fromRGB(255,255,0)
	distLabel.Font = Enum.Font.SourceSansBold
	distLabel.TextScaled = true
	distLabel.Text = "Dist: 0"
	distLabel.Parent = gui

	local velLabel = Instance.new("TextLabel")
	velLabel.Name = "Vel"
	velLabel.Size = UDim2.new(1,0,0.5,0)
	velLabel.Position = UDim2.new(0,0,0.5,0)
	velLabel.BackgroundTransparency = 1
	velLabel.TextColor3 = Color3.fromRGB(255,255,0)
	velLabel.Font = Enum.Font.SourceSansBold
	velLabel.TextScaled = true
	velLabel.Text = "Vel: 0"
	velLabel.Parent = gui

	local box = Instance.new("Frame")
	box.Size = UDim2.new(1,0,1,0)
	box.BackgroundTransparency = 1
	box.BorderColor3 = Color3.fromRGB(128,0,255)
	box.BorderSizePixel = 2
	box.Parent = gui
end

local function updateAllESP(landingPos)
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= player and plr.Character then
			createESPForCharacter(plr.Character)
			local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
			if hrp then
				local gui = hrp:FindFirstChild("TSB_ESP")
				if gui then
					gui.Dist.Text = "Dist: "..math.ceil((hrp.Position - landingPos).Magnitude)
					gui.Vel.Text = "Vel: "..math.ceil(hrp.AssemblyLinearVelocity.Magnitude)
				end
			end
		end
	end
end

-- ================= UPDATE =================
local function update()
	if not lineEnabled then return end

	clearThrown()

	local char = player.Character
	if not char then return end
	local root = char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local startPos =
		root.Position +
		root.CFrame.LookVector * START_BACK_OFFSET +
		Vector3.new(0,2,0)

	local landingPos = simulate(startPos, root.CFrame.LookVector)
	updateAllESP(landingPos)

	if cameraEnabled then
		camera.CameraType = Enum.CameraType.Scriptable
		camera.CFrame = CFrame.new(landingPos + Vector3.new(0,CAMERA_HEIGHT,0), landingPos)
	else
		camera.CameraType = Enum.CameraType.Custom
	end
end

-- ================= INPUT =================
UserInputService.InputBegan:Connect(function(input,gp)
	if gp then return end

	if input.KeyCode == Enum.KeyCode.L then
		lineEnabled = not lineEnabled
		if lineEnabled then
			RunService:BindToRenderStep("TSBUpdate", Enum.RenderPriority.Camera.Value, update)
		else
			RunService:UnbindFromRenderStep("TSBUpdate")
			clearPreview()
			clearThrown()
			camera.CameraType = Enum.CameraType.Custom
		end

	elseif input.KeyCode == Enum.KeyCode.M then
		if UserInputService.MouseBehavior == Enum.MouseBehavior.LockCenter then
			return
		end
		cameraEnabled = true
	end
end)

UserInputService.InputEnded:Connect(function(input,gp)
	if gp then return end
	if input.KeyCode == Enum.KeyCode.M then
		cameraEnabled = false
		clearPreview()
		clearThrown()
		camera.CameraType = Enum.CameraType.Custom
	end
end)
