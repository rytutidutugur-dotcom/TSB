-- TSB Metal Bat Predictor (STABLE + FIXED)

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera

-- ================= CONFIG =================
local lineEnabled = false
local cameraEnabled = false

local previewParts = {}
local espObjects = {}

local POWER = 120
local STEPS = 70
local STEP_TIME = 0.06
local GRAVITY = Workspace.Gravity * 0.12
local START_BACK_OFFSET = -14
local CAMERA_HEIGHT = 35

-- ================= UTIL =================
local function clearThrown()
	local thrown = Workspace:FindFirstChild("Thrown")
	if thrown then
		for _, v in ipairs(thrown:GetChildren()) do
			v:Destroy()
		end
	end
end

-- ================= LINE =================
local function clearLine()
	for _, p in ipairs(previewParts) do
		if p then p:Destroy() end
	end
	table.clear(previewParts)
end

local function makeDot(pos, landing)
	local p = Instance.new("Part")
	p.Anchored = true
	p.CanCollide = false
	p.Shape = Enum.PartType.Ball
	p.Material = Enum.Material.Neon
	p.Size = landing and Vector3.new(1.2,1.2,1.2) or Vector3.new(0.55,0.55,0.55)
	p.Color = landing and Color3.fromRGB(255,0,0) or Color3.fromRGB(255,255,255)
	p.Transparency = 0.15
	p.Position = pos
	p.Parent = Workspace
	table.insert(previewParts, p)
end

local function simulate(origin, dir)
	clearLine()

	local pos = origin
	local vel = dir.Unit * POWER
	local traveled = 0

	for i = 1, STEPS do
		if traveled > 60 then
			vel += Vector3.new(0, -GRAVITY * STEP_TIME, 0)
		end

		local nextPos = pos + vel * STEP_TIME
		traveled += (nextPos - pos).Magnitude

		local ray = Workspace:Raycast(pos, nextPos - pos)
		if ray then
			makeDot(ray.Position, true)
			return ray.Position
		end

		makeDot(nextPos)
		pos = nextPos
	end

	makeDot(pos, true)
	return pos
end

-- ================= ESP =================
local function removeESP(plr)
	if espObjects[plr] then
		espObjects[plr]:Destroy()
		espObjects[plr] = nil
	end
end

local function createESP(plr)
	if plr == player then return end
	if espObjects[plr] then return end

	local gui = Instance.new("BillboardGui")
	gui.Size = UDim2.new(0,140,0,60)
	gui.StudsOffset = Vector3.new(0,3,0)
	gui.AlwaysOnTop = true

	local frame = Instance.new("Frame")
	frame.Size = UDim2.new(1,0,1,0)
	frame.BackgroundTransparency = 1
	frame.BorderSizePixel = 2
	frame.BorderColor3 = Color3.fromRGB(255,255,255)
	frame.Parent = gui

	local text = Instance.new("TextLabel")
	text.Size = UDim2.new(1,0,1,0)
	text.BackgroundTransparency = 1
	text.TextColor3 = Color3.fromRGB(255,255,255)
	text.TextStrokeTransparency = 0
	text.TextScaled = true
	text.Font = Enum.Font.GothamBold
	text.Parent = frame

	espObjects[plr] = gui

	local function attach(char)
		local hrp = char:WaitForChild("HumanoidRootPart",5)
		if hrp then
			gui.Adornee = hrp
			gui.Parent = Workspace
		end
	end

	if plr.Character then
		attach(plr.Character)
	end

	plr.CharacterAdded:Connect(attach)

	RunService.RenderStepped:Connect(function()
		if not gui.Parent or not plr.Character then return end
		local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
		local myChar = player.Character
		if hrp and myChar and myChar:FindFirstChild("HumanoidRootPart") then
			local dist = (hrp.Position - myChar.HumanoidRootPart.Position).Magnitude
			local vel = hrp.AssemblyLinearVelocity.Magnitude
			text.Text = math.floor(dist) .. " studs\n" .. math.floor(vel) .. " vel"
		end
	end)
end

-- Handle players
for _, p in ipairs(Players:GetPlayers()) do
	createESP(p)
end

Players.PlayerAdded:Connect(createESP)
Players.PlayerRemoving:Connect(removeESP)

-- ================= UPDATE LOOP =================
RunService.RenderStepped:Connect(function()
	if not lineEnabled then return end

	clearThrown()

	local char = player.Character
	if not char then return end
	local root = char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local startPos = root.Position + root.CFrame.LookVector * START_BACK_OFFSET + Vector3.new(0,2,0)
	local landing = simulate(startPos, root.CFrame.LookVector)

	if cameraEnabled then
		camera.CameraType = Enum.CameraType.Scriptable
		camera.CFrame = CFrame.new(landing + Vector3.new(0,CAMERA_HEIGHT,0), landing)
	else
		camera.CameraType = Enum.CameraType.Custom
	end
end)

-- ================= INPUT =================
UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end

	if input.KeyCode == Enum.KeyCode.L then
		lineEnabled = not lineEnabled
		if not lineEnabled then
			clearLine()
			camera.CameraType = Enum.CameraType.Custom
		end

	elseif input.KeyCode == Enum.KeyCode.M then
		if UserInputService.MouseBehavior == Enum.MouseBehavior.LockCenter then
			return
		end
		cameraEnabled = true
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.KeyCode == Enum.KeyCode.M then
		cameraEnabled = false
		camera.CameraType = Enum.CameraType.Custom
	end
end)

player.CharacterAdded:Connect(function()
	camera.CameraType = Enum.CameraType.Custom
	clearLine()
end)
